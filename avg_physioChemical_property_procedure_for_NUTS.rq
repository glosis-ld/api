#+ summary: "Retrieve the average NitrogenTotal value for a specific geospatial region"
#+ description: "NOTE: make sure response content type is application/json"
#+ endpoint: "https://www.foodie-cloud.org/sparql"
#+ tags: [ "json" ]
#+ method: "GET"
#+ enumerate:
#+   - usedProcedure:
#+     - http://w3id.org/glosis/model/procedure#pHProcedure-pHH2O
#+     - http://w3id.org/glosis/model/procedure#carbonInorganicProcedure-InOrgC_calcul-caco3
#+     - http://w3id.org/glosis/model/procedure#carbonInorganicProcedure-InOrgC_calcul-tc-oc
#+     - http://w3id.org/glosis/model/procedure#porosityProcedure-Poros_calcul-pf0
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca01
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-dc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca05
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-hcl-dc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-ch3cooh-dc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca10
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca02
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-hcl-unkn
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca06
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-nodc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-ch3cooh-unkn
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-h2so4-nodc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_calcul-tc-oc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-h3po4-unkn
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca11
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca12
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-h2so4-unkn
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca03
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca07
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-h3po4-dc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-ch3cooh-nodc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca04
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca08
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-hcl-nodc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-h3po4-nodc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_ca09
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-h2so4-dc
#+     - http://w3id.org/glosis/model/procedure#totalCarbonateEquivalentProcedure-CaCO3_acid-unkn
#+     - http://w3id.org/glosis/model/procedure#bulkDensityWholeSoilProcedure-BlkDensW_we-cl-od
#+     - http://w3id.org/glosis/model/procedure#bulkDensityWholeSoilProcedure-BlkDensW_we-co-fc
#+     - http://w3id.org/glosis/model/procedure#bulkDensityWholeSoilProcedure-BlkDensW_we-unkn
#+     - http://w3id.org/glosis/model/procedure#bulkDensityWholeSoilProcedure-BlkDensW_we-cl-fc
#+     - http://w3id.org/glosis/model/procedure#bulkDensityWholeSoilProcedure-BlkDensW_we-co-od
#+     - http://w3id.org/glosis/model/procedure#bulkDensityWholeSoilProcedure-BlkDensW_we-co-unkn
#+     - http://w3id.org/glosis/model/procedure#bulkDensityWholeSoilProcedure-BlkDensW_we-rpl-unkn
#+     - http://w3id.org/glosis/model/procedure#bulkDensityWholeSoilProcedure-BlkDensW_we-cl-unkn
#+     - http://w3id.org/glosis/model/procedure#baseSaturationProcedure-BSat_calcul-cec
#+     - http://w3id.org/glosis/model/procedure#baseSaturationProcedure-BSat_calcul-ecec
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_hcl-aquaregia
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_tp04
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_tp09
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_xrd
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_tp10
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_tp05
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_tp06
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_unkn
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_hcl
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_h2so4
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_xrf
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_xrf-p
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_nh4-6mo7o24
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_tp07
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_xtf-t
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_tp03
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_hno3-aquafortis
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_tp08
#+     - http://w3id.org/glosis/model/procedure#totalElementsProcedure-Total_hclo4
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-unkn-fc
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-cl-od
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-cl-fc
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-co-od
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-unkn-od
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-co-fc
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-rpl-unkn
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-unkn
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-cl-unkn
#+     - http://w3id.org/glosis/model/procedure#bulkDensityFineEarthProcedure-BlkDensF_fe-co-unkn
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_ud-cl
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_d
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_d-cl
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_calcul-ptf
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_d-ww
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_d-cl-ww
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_ud-co
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_ud
#+     - http://w3id.org/glosis/model/procedure#moistureContentProcedure-VMC_calcul-ptf-brookscorey
#+     - http://w3id.org/glosis/model/procedure#organicMatterProcedure-TotHumC_unkn
#+     - http://w3id.org/glosis/model/procedure#organicMatterProcedure-FulAcidC_unkn
#+     - http://w3id.org/glosis/model/procedure#organicMatterProcedure-OrgM_calcul-oc1.73
#+     - http://w3id.org/glosis/model/procedure#organicMatterProcedure-HumAcidC_unkn
#+     - http://w3id.org/glosis/model/procedure#effectiveCecProcedure-EffCEC_calcul-ba
#+     - http://w3id.org/glosis/model/procedure#effectiveCecProcedure-EffCEC_calcul-b
#+     - http://w3id.org/glosis/model/procedure#carbonTotalProcedure-TotC_calcul-ic-oc
#+     - http://w3id.org/glosis/model/procedure#carbonTotalProcedure-TotC_dc-mt
#+     - http://w3id.org/glosis/model/procedure#carbonTotalProcedure-TotC_dc-ht-spec
#+     - http://w3id.org/glosis/model/procedure#carbonTotalProcedure-TotC_dc-ht
#+     - http://w3id.org/glosis/model/procedure#carbonTotalProcedure-TotC_dc-ht-analyser
#+     - http://w3id.org/glosis/model/procedure#solubleSaltsProcedure-SlbAn_calcul-unkn
#+     - http://w3id.org/glosis/model/procedure#solubleSaltsProcedure-SlbCat_calcul-unkn
#+   - physioChemicalProperty:
#+     - http://w3id.org/glosis/model/layerhorizon#CalciumExchangeableBases
#+     - http://w3id.org/glosis/model/layerhorizon#MolybdenumTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#SulfurExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#AcidityExchangeable
#+     - http://w3id.org/glosis/model/layerhorizon#MagnesiumTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#PotassiumExchangeableBases
#+     - http://w3id.org/glosis/model/layerhorizon#SandFractionTexture
#+     - http://w3id.org/glosis/model/layerhorizon#SodiumExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#ManganeseExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#BoronExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#CopperExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#IronTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#ElectricalConductivity
#+     - http://w3id.org/glosis/model/layerhorizon#CadmiumTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#ClayFractionTexture
#+     - http://w3id.org/glosis/model/layerhorizon#HydraulicConductivity
#+     - http://w3id.org/glosis/model/layerhorizon#SiltFractionTexture
#+     - http://w3id.org/glosis/model/layerhorizon#CarbonTotal
#+     - http://w3id.org/glosis/model/layerhorizon#CarbonInorganic
#+     - http://w3id.org/glosis/model/layerhorizon#ZincTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#OrganicMatter
#+     - http://w3id.org/glosis/model/layerhorizon#PH
#+     - http://w3id.org/glosis/model/layerhorizon#CarbonOrganic
#+     - http://w3id.org/glosis/model/layerhorizon#PhosphorusExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#PhosphorusRetention
#+     - http://w3id.org/glosis/model/layerhorizon#ManganeseExchangeableBases
#+     - http://w3id.org/glosis/model/layerhorizon#PotassiumExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#ZincExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#SolubleSalts
#+     - http://w3id.org/glosis/model/layerhorizon#CadmiumExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#MolybdenumExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#EffectiveCec
#+     - http://w3id.org/glosis/model/layerhorizon#HydrogenExchangeableBases
#+     - http://w3id.org/glosis/model/layerhorizon#PhosphorusTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#AluminiumExchangeableBases
#+     - http://w3id.org/glosis/model/layerhorizon#BaseSaturation
#+     - http://w3id.org/glosis/model/layerhorizon#Gypsum
#+     - http://w3id.org/glosis/model/layerhorizon#PotassiumTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#TotalCarbonateEquivalent
#+     - http://w3id.org/glosis/model/layerhorizon#BulkDensityFineEarth
#+     - http://w3id.org/glosis/model/layerhorizon#ManganeseTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#BulkDensityWholeSoil
#+     - http://w3id.org/glosis/model/layerhorizon#AluminiumTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#SodiumTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#NitrogenTotal
#+     - http://w3id.org/glosis/model/layerhorizon#IronExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#CoarseFragments
#+     - http://w3id.org/glosis/model/layerhorizon#SodiumExchangeableBases
#+     - http://w3id.org/glosis/model/layerhorizon#CationExchangeCapacitycSoil
#+     - http://w3id.org/glosis/model/layerhorizon#MagnesiumExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#AvailableWaterHoldingCapacity
#+     - http://w3id.org/glosis/model/layerhorizon#MagnesiumExchangeableBases
#+     - http://w3id.org/glosis/model/layerhorizon#SulfurTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#CalciumExtractableElements
#+     - http://w3id.org/glosis/model/layerhorizon#CopperTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#CalciumTotalElements
#+     - http://w3id.org/glosis/model/layerhorizon#Porosity
#+     - http://w3id.org/glosis/model/layerhorizon#BoronTotalElements
#+ defaults:
#+   - physioChemicalProperty: http://w3id.org/glosis/model/layerhorizon#PH
#+   - usedProcedure: http://w3id.org/glosis/model/procedure#pHProcedure-pHH2O
#+ transform: {
#+   "physioChemicalProperty": "?property",
#+   "$anchor": "physioChemicalProperty",
#+   "avg_physioChemicalPropertytotal": "?avg_physioChemicalPropertytotal",
#+ }


PREFIX sosa: <http://www.w3.org/ns/sosa/>
PREFIX qudt: <http://qudt.org/schema/qudt/>
PREFIX glosis_lh: <http://w3id.org/glosis/model/layerhorizon#>
PREFIX geo: <http://www.opengis.net/ont/geosparql#>
PREFIX geof: <http://www.opengis.net/def/function/geosparql/>
PREFIX iso: <http://w3id.org/glosis/model/iso28258/2013#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX ramon: <http://rdfdata.eionet.europa.eu/ramon/ontology/>

SELECT (AVG(?value) as ?avg_physioChemicalPropertytotal) (REPLACE(STR(?_physioChemicalProperty_iri), "^.*#([^#]*)$", "$1") as ?property)
WHERE {
    ?obs a ?_physioChemicalProperty_iri ;
         sosa:hasResult ?res ;
         sosa:hasFeatureOfInterest ?lay ;
         sosa:usedProcedure ?_usedProcedure_iri .
    ?res qudt:numericValue ?value .
    ?site iso:Site.typicalProfile/iso:Profile.element ?lay ;
         geo:hasGeometry/geo:asWKT ?geom .
    {
      SELECT ?g_nuts
      WHERE {
        ?n a ramon:NUTSRegion .
        ?n rdfs:label ?l .
        ?n geo:asWKT ?g_nuts .
        ?l bif:contains ?_nutsCode .
      } limit 1
    }
    FILTER (geof:sfIntersects(?geom, ?g_nuts))
}
